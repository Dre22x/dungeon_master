<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dungeon Master - Campaign</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Lora:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
            background-color: #1a1a1a;
            background-image: url('https://www.transparenttextures.com/patterns/crissxcross.png'), linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8));
            color: #e0e0e0;
        }
        .font-medieval {
            font-family: 'MedievalSharp', cursive;
        }
        .main-container {
            border: 1px solid #4a3a2a;
            background-color: rgba(26, 26, 26, 0.85);
            box-shadow: 0 0 30px rgba(255, 199, 0, 0.1);
        }
        .btn-primary {
            font-family: 'MedievalSharp', cursive;
            background-color: #8a6d3b;
            border: 1px solid #7a5d2b;
            color: #f5f5f5;
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .btn-primary:hover {
            background-color: #a08252;
            box-shadow: 0 0 15px rgba(255, 199, 0, 0.3);
            transform: translateY(-2px);
        }
        .input-field {
            background-color: #2a2a2a;
            border: 1px solid #4a3a2a;
            color: #e0e0e0;
        }
        .input-field:focus {
            outline: none;
            border-color: #8a6d3b;
            box-shadow: 0 0 10px rgba(138, 109, 59, 0.5);
        }
        .chat-container {
            height: 60vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a3a2a #2a2a2a;
        }
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #2a2a2a;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #4a3a2a;
            border-radius: 4px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #8a6d3b;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            max-width: 80%;
        }
        .user-message {
            background-color: #4a3a2a;
            border-left: 4px solid #8a6d3b;
            margin-left: auto;
        }
        .agent-message {
            background-color: #2a2a2a;
            border-left: 4px solid #d4af37;
        }
        .system-message {
            background-color: #1a1a1a;
            border-left: 4px solid #666;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }
        .typing-indicator {
            display: none;
            color: #d4af37;
            font-style: italic;
        }
        .campaign-info {
            background-color: rgba(74, 58, 42, 0.3);
            border: 1px solid #4a3a2a;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-6">
            <h1 class="font-medieval text-4xl md:text-5xl text-amber-300">Dungeon Master</h1>
            <p class="text-lg text-gray-400 mt-2">Campaign Session</p>
        </header>

        <!-- Campaign Info -->
        <div id="campaignInfo" class="campaign-info">
            <h3 class="font-medieval text-xl text-amber-300 mb-2">Campaign ID: <span id="campaignId">Loading...</span></h3>
            <p id="campaignStatus" class="text-gray-400">Initializing...</p>
        </div>

        <!-- Tab Navigation -->
        <div class="flex mb-4">
            <button id="chatTab" class="btn-primary px-6 py-3 text-lg rounded-l-md border-r border-amber-600">
                Chat
            </button>
            <button id="charactersTab" class="btn-primary px-6 py-3 text-lg border-r border-amber-600 opacity-75 hover:opacity-100">
                Characters
            </button>
            <button id="debugTab" class="btn-primary px-6 py-3 text-lg rounded-r-md opacity-75 hover:opacity-100">
                Debug
            </button>
        </div>

        <!-- Chat Tab Content -->
        <div id="chatTabContent" class="main-container rounded-lg p-6">
            <!-- Chat Messages -->
            <div id="chatContainer" class="chat-container mb-4 p-4">
                <div class="message system-message">
                    Welcome to your D&D campaign! The Dungeon Master is ready to guide your adventure.
                </div>
            </div>

            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator mb-4">
                The Dungeon Master is thinking...
            </div>

            <!-- Input Area -->
            <div class="flex gap-4">
                <input 
                    id="messageInput" 
                    type="text" 
                    placeholder="Type your message here..." 
                    class="input-field flex-grow px-4 py-3 rounded-md text-lg focus:ring-2 focus:ring-amber-400"
                    disabled
                >
                <button 
                    id="sendButton" 
                    class="btn-primary px-6 py-3 text-lg rounded-md"
                    disabled
                >
                    Send
                </button>
            </div>
        </div>

        <!-- Characters Tab Content -->
        <div id="charactersTabContent" class="main-container rounded-lg p-6 hidden">
            <h3 class="font-medieval text-2xl text-amber-300 mb-4">Campaign Characters</h3>
            <div id="charactersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Characters will be loaded here -->
            </div>
            <div id="noCharactersMessage" class="text-center text-gray-400 py-8 hidden">
                <p class="text-lg">No characters found in this campaign.</p>
                <p class="text-sm mt-2">Characters will appear here once they are created.</p>
            </div>
        </div>

        <!-- Debug Tab Content -->
        <div id="debugTabContent" class="main-container rounded-lg p-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-medieval text-2xl text-amber-300">Enhanced Debug Console</h3>
                <div class="flex gap-2">
                    <button id="clearDebugBtn" class="btn-primary px-4 py-2 text-sm rounded-md">
                        Clear
                    </button>
                    <button id="toggleAutoScrollBtn" class="btn-primary px-4 py-2 text-sm rounded-md">
                        Auto-scroll: ON
                    </button>
                    <button id="showSummaryBtn" class="btn-primary px-4 py-2 text-sm rounded-md">
                        Show Summary
                    </button>
                </div>
            </div>
            
            <!-- Filter Controls -->
            <div class="mb-4 p-3 bg-gray-800 border border-gray-600 rounded-lg">
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-sm text-gray-300">Filter:</span>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="agent_activated" checked> 
                        <span class="ml-1 text-purple-400">ü§ñ Agents</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="agent_transfer" checked> 
                        <span class="ml-1 text-cyan-400">üîÑ Transfers</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="tool_call" checked> 
                        <span class="ml-1 text-orange-400">üîß Tools</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="tool_result" checked> 
                        <span class="ml-1 text-green-400">‚úÖ Results</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="final_response" checked> 
                        <span class="ml-1 text-blue-400">üì§ Responses</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="agent_error" checked> 
                        <span class="ml-1 text-red-400">üí• Errors</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="api" checked> 
                        <span class="ml-1 text-blue-400">üåê API</span>
                    </label>
                    <label class="flex items-center text-sm">
                        <input type="checkbox" class="debug-filter" data-type="console" checked> 
                        <span class="ml-1 text-green-400">üìù Console</span>
                    </label>
                </div>
            </div>
            
            <div id="debugContainer" class="bg-black border border-gray-600 rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm">
                <div class="text-green-400">Enhanced debug console initialized...</div>
                <div class="text-yellow-400">Waiting for debug output...</div>
            </div>
            <div class="mt-4 text-sm text-gray-400">
                <p>This enhanced debug console shows:</p>
                <ul class="list-disc list-inside mt-2 space-y-1">
                    <li>ü§ñ Agent activations and descriptions</li>
                    <li>üîÑ Agent transfers and escalations with reasons</li>
                    <li>üîß Tool calls with arguments and parameters</li>
                    <li>‚úÖ Tool results and success/failure status</li>
                    <li>üì§ Final responses with character counts</li>
                    <li>üí• Agent errors with detailed error information</li>
                    <li>üåê API calls and responses</li>
                    <li>üìù Console output from the backend</li>
                    <li>‚ö†Ô∏è Warning messages and debugging info</li>
                </ul>
                <p class="mt-2 text-xs text-gray-500">Click "Show Details" to expand detailed information for each event.</p>
            </div>
        </div>

        <!-- Character Detail Modal -->
        <div id="characterModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-gray-800 border border-amber-600 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 id="modalCharacterName" class="font-medieval text-2xl text-amber-300"></h2>
                            <button id="closeModalBtn" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div id="characterDetails" class="space-y-4">
                            <!-- Character details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Back to Menu Button -->
        <div class="text-center mt-6">
            <button id="backToMenuBtn" class="btn-primary px-8 py-3 text-xl rounded-md">
                Back to Menu
            </button>
        </div>
    </div>

    <script>
        let currentCampaignId = null;
        let isInitialized = false;
        let debugWebSocket = null;
        let autoScrollEnabled = true;
        let debugMessages = []; // Store all debug messages for filtering and summary
        let activeFilters = new Set(['agent_activated', 'agent_transfer', 'tool_call', 'tool_result', 'final_response', 'agent_error', 'api', 'console']);

        // Debug console functions
        function addDebugMessage(message, type = 'info', data = null) {
            const debugContainer = document.getElementById('debugContainer');
            const messageDiv = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString();
            let colorClass = 'text-gray-300';
            let icon = '‚ÑπÔ∏è';
            
            switch (type) {
                case 'agent_activated':
                    colorClass = 'text-purple-400';
                    icon = 'ü§ñ';
                    break;
                case 'agent_transfer':
                    colorClass = 'text-cyan-400';
                    icon = 'üîÑ';
                    break;
                case 'tool_call':
                    colorClass = 'text-orange-400';
                    icon = 'üîß';
                    break;
                case 'tool_result':
                    colorClass = 'text-green-400';
                    icon = '‚úÖ';
                    break;
                case 'final_response':
                    colorClass = 'text-blue-400';
                    icon = 'üì§';
                    break;
                case 'agent_error':
                    colorClass = 'text-red-400';
                    icon = 'üí•';
                    break;
                case 'console':
                    colorClass = 'text-green-400';
                    icon = 'üìù';
                    break;
                case 'api':
                    colorClass = 'text-blue-400';
                    icon = 'üåê';
                    break;
                case 'error':
                    colorClass = 'text-red-400';
                    icon = '‚ùå';
                    break;
                case 'warning':
                    colorClass = 'text-yellow-400';
                    icon = '‚ö†Ô∏è';
                    break;
                default:
                    colorClass = 'text-gray-300';
                    icon = '‚ÑπÔ∏è';
            }
            
            // Store message for filtering and summary
            const debugEntry = {
                message: message,
                type: type,
                data: data,
                timestamp: timestamp,
                element: null
            };
            debugMessages.push(debugEntry);
            
            // Create the main message
            const messageText = `${icon} [${timestamp}] ${message}`;
            messageDiv.className = `${colorClass} mb-1 debug-message`;
            messageDiv.setAttribute('data-type', type);
            messageDiv.textContent = messageText;
            
            // Add expandable data section if data exists
            if (data && Object.keys(data).length > 0) {
                const dataDiv = document.createElement('div');
                dataDiv.className = 'ml-4 mb-2';
                
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'text-xs text-gray-400 hover:text-gray-300 cursor-pointer mb-1';
                toggleBtn.textContent = 'üìã Show Details';
                
                const dataContent = document.createElement('div');
                dataContent.className = 'hidden bg-gray-800 border border-gray-600 rounded p-2 text-xs font-mono';
                dataContent.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                toggleBtn.onclick = function() {
                    if (dataContent.classList.contains('hidden')) {
                        dataContent.classList.remove('hidden');
                        toggleBtn.textContent = 'üìã Hide Details';
                    } else {
                        dataContent.classList.add('hidden');
                        toggleBtn.textContent = 'üìã Show Details';
                    }
                };
                
                dataDiv.appendChild(toggleBtn);
                dataDiv.appendChild(dataContent);
                messageDiv.appendChild(dataDiv);
            }
            
            debugEntry.element = messageDiv;
            debugContainer.appendChild(messageDiv);
            
            // Apply current filters
            applyFilters();
            
            if (autoScrollEnabled) {
                debugContainer.scrollTop = debugContainer.scrollHeight;
            }
        }

        function applyFilters() {
            const messages = document.querySelectorAll('.debug-message');
            messages.forEach(msg => {
                const type = msg.getAttribute('data-type');
                if (activeFilters.has(type)) {
                    msg.style.display = 'block';
                } else {
                    msg.style.display = 'none';
                }
            });
        }

        function showSummary() {
            const summary = {
                total: debugMessages.length,
                byType: {},
                agents: new Set(),
                tools: new Set(),
                errors: 0
            };
            
            debugMessages.forEach(entry => {
                // Count by type
                summary.byType[entry.type] = (summary.byType[entry.type] || 0) + 1;
                
                // Track agents
                if (entry.type === 'agent_activated' && entry.data && entry.data.agent_name) {
                    summary.agents.add(entry.data.agent_name);
                }
                
                // Track tools
                if (entry.type === 'tool_call' && entry.data && entry.data.tool_name) {
                    summary.tools.add(entry.data.tool_name);
                }
                
                // Count errors
                if (entry.type === 'agent_error' || entry.type === 'error') {
                    summary.errors++;
                }
            });
            
            const summaryText = `
üìä DEBUG SUMMARY:
Total Events: ${summary.total}
Errors: ${summary.errors}
Agents Used: ${Array.from(summary.agents).join(', ') || 'None'}
Tools Called: ${Array.from(summary.tools).join(', ') || 'None'}

Event Breakdown:
${Object.entries(summary.byType).map(([type, count]) => `  ${type}: ${count}`).join('\n')}
            `.trim();
            
            addDebugMessage(summaryText, 'console');
        }

        function clearDebugConsole() {
            const debugContainer = document.getElementById('debugContainer');
            debugContainer.innerHTML = '<div class="text-green-400">Debug console cleared...</div>';
            debugMessages = []; // Clear stored messages
            applyFilters(); // Re-apply filters to show only cleared message
        }

        function toggleAutoScroll() {
            autoScrollEnabled = !autoScrollEnabled;
            const button = document.getElementById('toggleAutoScrollBtn');
            button.textContent = `Auto-scroll: ${autoScrollEnabled ? 'ON' : 'OFF'}`;
            
            if (autoScrollEnabled) {
                const debugContainer = document.getElementById('debugContainer');
                debugContainer.scrollTop = debugContainer.scrollHeight;
            }
        }

        function setupDebugWebSocket() {
            if (debugWebSocket) {
                debugWebSocket.close();
            }
            
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/debug-stream/${currentCampaignId}`;
            
            debugWebSocket = new WebSocket(wsUrl);
            
            debugWebSocket.onopen = function() {
                addDebugMessage('WebSocket connection established for debug stream', 'info');
            };
            
            debugWebSocket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    addDebugMessage(data.message, data.type, data.data);
                } catch (error) {
                    addDebugMessage(`Failed to parse debug message: ${error.message}`, 'error');
                }
            };
            
            debugWebSocket.onerror = function(error) {
                addDebugMessage(`WebSocket error: ${error}`, 'error');
            };
            
            debugWebSocket.onclose = function() {
                addDebugMessage('WebSocket connection closed', 'warning');
            };
        }

        // Get campaign ID from URL parameters
        function getCampaignIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('campaign_id');
        }

        // Initialize the campaign
        async function initializeCampaign() {
            const campaignId = getCampaignIdFromUrl();
            if (!campaignId) {
                showMessage('Error: No campaign ID provided', 'system');
                return;
            }

            currentCampaignId = campaignId;
            document.getElementById('campaignId').textContent = campaignId;
            document.getElementById('campaignStatus').textContent = 'Initializing...';

            // Set up debug WebSocket connection
            setupDebugWebSocket();

            try {
                // Initialize the agent for this campaign
                const response = await fetch('/initialize-campaign', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ campaign_id: campaignId })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('campaignStatus').textContent = 'Ready';
                    isInitialized = true;
                    enableInput();
                    
                    if (data.agent_response) {
                        showMessage(data.agent_response, 'agent');
                    }
                } else {
                    showMessage('Error initializing campaign: ' + data.message, 'system');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error initializing campaign', 'system');
            }
        }

        // Convert markdown to HTML
        function markdownToHtml(text) {
            return text
                // Convert **bold** to <strong>bold</strong>
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                // Convert *italic* to <em>italic</em>
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                // Convert line breaks to <br>
                .replace(/\n/g, '<br>');
        }

        // Show a message in the chat
        function showMessage(text, type) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // Convert markdown to HTML for agent messages, use plain text for user messages
            if (type === 'agent') {
                messageDiv.innerHTML = markdownToHtml(text);
            } else {
                messageDiv.textContent = text;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Enable input after initialization
        function enableInput() {
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').focus();
        }

        // Send message to agent
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !isInitialized) return;

            // Show user message
            showMessage(message, 'user');
            input.value = '';

            // Add debug logging
            addDebugMessage(`Sending message: "${message}"`, 'api');

            // Show typing indicator
            const typingIndicator = document.getElementById('typingIndicator');
            typingIndicator.style.display = 'block';

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        campaign_id: currentCampaignId,
                        message: message
                    })
                });

                const data = await response.json();
                
                // Add debug logging for response
                addDebugMessage(`Received response: ${data.status}`, 'api');
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';

                if (data.status === 'success') {
                    showMessage(data.agent_response, 'agent');
                } else {
                    showMessage('Error: ' + data.message, 'system');
                    addDebugMessage(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                showMessage('Error sending message', 'system');
                addDebugMessage(`Network error: ${error.message}`, 'error');
            }
        }

        // Event listeners
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        document.getElementById('backToMenuBtn').addEventListener('click', function() {
            window.location.href = '/';
        });

        // Tab functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.getElementById('chatTabContent').classList.add('hidden');
            document.getElementById('charactersTabContent').classList.add('hidden');
            document.getElementById('debugTabContent').classList.add('hidden'); // Hide debug tab content
            
            // Remove active state from all tabs
            document.getElementById('chatTab').classList.remove('opacity-100');
            document.getElementById('chatTab').classList.add('opacity-75');
            document.getElementById('charactersTab').classList.remove('opacity-100');
            document.getElementById('charactersTab').classList.add('opacity-75');
            document.getElementById('debugTab').classList.remove('opacity-100');
            document.getElementById('debugTab').classList.add('opacity-75');
            
            // Show selected tab content
            document.getElementById(tabName + 'TabContent').classList.remove('hidden');
            
            // Add active state to selected tab
            document.getElementById(tabName + 'Tab').classList.remove('opacity-75');
            document.getElementById(tabName + 'Tab').classList.add('opacity-100');
            
            // Load characters if switching to characters tab
            if (tabName === 'characters') {
                loadCharacters();
            }
            
            // Set up debug WebSocket if switching to debug tab
            if (tabName === 'debug' && currentCampaignId) {
                setupDebugWebSocket();
            }
        }

        // Load characters for the campaign
        async function loadCharacters() {
            if (!currentCampaignId) return;
            
            try {
                const response = await fetch(`/campaign/${currentCampaignId}/characters`);
                const data = await response.json();
                
                const charactersList = document.getElementById('charactersList');
                const noCharactersMessage = document.getElementById('noCharactersMessage');
                
                if (data.status === 'success') {
                    const characters = data.characters;
                    
                    if (characters.length === 0) {
                        charactersList.innerHTML = '';
                        noCharactersMessage.classList.remove('hidden');
                    } else {
                        noCharactersMessage.classList.add('hidden');
                        charactersList.innerHTML = '';
                        
                        characters.forEach(character => {
                            const characterCard = createCharacterCard(character);
                            charactersList.appendChild(characterCard);
                        });
                    }
                } else {
                    console.error('Error loading characters:', data.message);
                    showMessage('Error loading characters: ' + data.message, 'system');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Error loading characters', 'system');
            }
        }

        // Create a character card
        function createCharacterCard(character) {
            const card = document.createElement('div');
            card.className = 'bg-gray-700 border border-amber-600 rounded-lg p-4 hover:bg-gray-600 cursor-pointer transition-colors';
            
            const abilityScores = character.ability_scores || {};
            const str = abilityScores.Strength || abilityScores.STR || 10;
            const dex = abilityScores.Dexterity || abilityScores.DEX || 10;
            const con = abilityScores.Constitution || abilityScores.CON || 10;
            
            card.innerHTML = `
                <h4 class="font-medieval text-lg text-amber-300 mb-2">${character.name}</h4>
                <p class="text-gray-300 text-sm mb-2">${character.race} ${character.class} (Level ${character.level})</p>
                <p class="text-gray-400 text-xs mb-2">${character.background} ‚Ä¢ ${character.alignment}</p>
                <div class="flex justify-between text-xs text-gray-400">
                    <span>STR: ${str}</span>
                    <span>DEX: ${dex}</span>
                    <span>CON: ${con}</span>
                </div>
            `;
            
            card.addEventListener('click', () => showCharacterDetails(character));
            return card;
        }

        // Show character details in modal
        function showCharacterDetails(character) {
            const modal = document.getElementById('characterModal');
            const modalName = document.getElementById('modalCharacterName');
            const characterDetails = document.getElementById('characterDetails');
            
            modalName.textContent = character.name;
            
            const abilityScores = character.ability_scores || {};
            const skills = character.skills || [];
            const proficiencies = character.proficiencies || [];
            const equipment = character.equipment || [];
            const inventory = character.inventory || [];
            const spells = character.spells || [];
            
            // Debug logging
            console.log('Character data:', character);
            console.log('Skills:', skills);
            console.log('Proficiencies:', proficiencies);
            
            characterDetails.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Basic Info -->
                    <div class="space-y-2">
                        <h3 class="font-medieval text-lg text-amber-300">Basic Information</h3>
                        <div class="bg-gray-700 p-3 rounded">
                            <p><strong>Race:</strong> ${character.race}</p>
                            <p><strong>Class:</strong> ${character.class} (Level ${character.level})</p>
                            <p><strong>Background:</strong> ${character.background}</p>
                            <p><strong>Alignment:</strong> ${character.alignment}</p>
                            <p><strong>Experience:</strong> ${character.experience || 0} XP</p>
                        </div>
                    </div>
                    
                    <!-- Ability Scores -->
                    <div class="space-y-2">
                        <h3 class="font-medieval text-lg text-amber-300">Ability Scores</h3>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <p><strong>STR:</strong> ${abilityScores.Strength || abilityScores.STR || 10}</p>
                                <p><strong>DEX:</strong> ${abilityScores.Dexterity || abilityScores.DEX || 10}</p>
                                <p><strong>CON:</strong> ${abilityScores.Constitution || abilityScores.CON || 10}</p>
                                <p><strong>INT:</strong> ${abilityScores.Intelligence || abilityScores.INT || 10}</p>
                                <p><strong>WIS:</strong> ${abilityScores.Wisdom || abilityScores.WIS || 10}</p>
                                <p><strong>CHA:</strong> ${abilityScores.Charisma || abilityScores.CHA || 10}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills -->
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Skills</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        ${skills.length > 0 ? 
                            skills.map(skill => `
                                <div class="skill-item mb-2">
                                    <button class="text-amber-300 hover:text-amber-200 text-sm font-medium expand-btn" 
                                            data-type="skill" data-name="${skill}">
                                        üìñ ${skill}
                                    </button>
                                    <div class="skill-details hidden mt-2 p-2 bg-gray-600 rounded text-xs"></div>
                                </div>
                            `).join('') : 
                            '<p class="text-sm text-gray-400">No skills listed</p>'
                        }
                    </div>
                </div>
                
                <!-- Proficiencies -->
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Proficiencies</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        ${proficiencies.length > 0 ? 
                            proficiencies.map(prof => `
                                <div class="proficiency-item mb-2">
                                    <button class="text-amber-300 hover:text-amber-200 text-sm font-medium expand-btn" 
                                            data-type="proficiency" data-name="${prof}">
                                        ‚öîÔ∏è ${prof}
                                    </button>
                                    <div class="proficiency-details hidden mt-2 p-2 bg-gray-600 rounded text-xs"></div>
                                </div>
                            `).join('') : 
                            '<p class="text-sm text-gray-400">No proficiencies listed</p>'
                        }
                    </div>
                </div>
                
                <!-- Equipment -->
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Equipment</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        ${equipment.length > 0 ? 
                            equipment.map(item => `
                                <div class="equipment-item mb-2">
                                    <button class="text-amber-300 hover:text-amber-200 text-sm font-medium expand-btn" 
                                            data-type="equipment" data-name="${item}">
                                        üõ°Ô∏è ${item}
                                    </button>
                                    <div class="equipment-details hidden mt-2 p-2 bg-gray-600 rounded text-xs"></div>
                                </div>
                            `).join('') : 
                            '<p class="text-sm text-gray-400">No equipment listed</p>'
                        }
                    </div>
                </div>
                
                <!-- Inventory -->
                ${inventory.length > 0 ? `
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Inventory</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        ${inventory.map(item => `
                            <div class="inventory-item mb-2">
                                <button class="text-amber-300 hover:text-amber-200 text-sm font-medium expand-btn" 
                                        data-type="equipment" data-name="${item}">
                                    üéí ${item}
                                </button>
                                <div class="inventory-details hidden mt-2 p-2 bg-gray-600 rounded text-xs"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Spells -->
                ${spells.length > 0 ? `
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Spells</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        ${spells.map(spell => `
                            <div class="spell-item mb-2">
                                <button class="text-amber-300 hover:text-amber-200 text-sm font-medium expand-btn" 
                                        data-type="spell" data-name="${spell}">
                                    ‚ú® ${spell}
                                </button>
                                <div class="spell-details hidden mt-2 p-2 bg-gray-600 rounded text-xs"></div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                <!-- Notes -->
                ${character.notes ? `
                <div class="space-y-2">
                    <h3 class="font-medieval text-lg text-amber-300">Notes</h3>
                    <div class="bg-gray-700 p-3 rounded">
                        <p class="text-sm">${character.notes}</p>
                    </div>
                </div>
                ` : ''}
            `;
            
            // Add event listeners for expandable items
            addExpandableItemListeners();
            
            modal.classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('characterModal').classList.add('hidden');
        }

        // Global mappings for skill and proficiency indexes
        let skillNameToIndex = {};
        let proficiencyNameToIndex = {};

        // Fetch mappings on page load
        async function fetchIndexMappings() {
            try {
                const [skillsRes, profsRes] = await Promise.all([
                    fetch('/api/skills_index'),
                    fetch('/api/proficiencies_index')
                ]);
                const skillsData = await skillsRes.json();
                const profsData = await profsRes.json();
                if (skillsData.status === 'success') skillNameToIndex = skillsData.mapping;
                if (profsData.status === 'success') proficiencyNameToIndex = profsData.mapping;
            } catch (e) {
                console.error('Error fetching index mappings:', e);
            }
        }

        // Patch: fetch mappings before initializing campaign
        async function initializeApp() {
            await fetchIndexMappings();
            initializeCampaign();
        }

        // Event listeners for tabs
        document.getElementById('chatTab').addEventListener('click', () => switchTab('chat'));
        document.getElementById('charactersTab').addEventListener('click', () => switchTab('characters'));
        document.getElementById('debugTab').addEventListener('click', () => switchTab('debug')); // Add event listener for debug tab
        document.getElementById('closeModalBtn').addEventListener('click', closeModal);
        
        // Debug console event listeners
        document.getElementById('clearDebugBtn').addEventListener('click', clearDebugConsole);
        document.getElementById('toggleAutoScrollBtn').addEventListener('click', toggleAutoScroll);
        document.getElementById('showSummaryBtn').addEventListener('click', showSummary);
        
        // Filter event listeners
        document.querySelectorAll('.debug-filter').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const type = this.getAttribute('data-type');
                if (this.checked) {
                    activeFilters.add(type);
                } else {
                    activeFilters.delete(type);
                }
                applyFilters();
            });
        });
        
        // Add event listeners for expandable items
        function addExpandableItemListeners() {
            const expandButtons = document.querySelectorAll('.expand-btn');
            expandButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const type = this.getAttribute('data-type');
                    const name = this.getAttribute('data-name');
                    let apiName = name;
                    
                    // Normalize equipment names for API lookup
                    if (type === 'equipment') {
                        // Remove quantity (e.g., "10 rations" -> "rations")
                        apiName = name.replace(/^\d+\s+/, '');
                        // Convert to singular form for common items
                        const singularMap = {
                            'rations': 'ration',
                            'torches': 'torch',
                            'arrows': 'arrow',
                            'bolts': 'bolt',
                            'darts': 'dart',
                            'javelins': 'javelin',
                            'spears': 'spear',
                            'daggers': 'dagger',
                            'swords': 'sword',
                            'axes': 'axe',
                            'hammers': 'hammer',
                            'maces': 'mace',
                            'flails': 'flail',
                            'whips': 'whip',
                            'poles': 'pole',
                            'staves': 'staff',
                            'bows': 'bow',
                            'crossbows': 'crossbow',
                            'slings': 'sling',
                            'nets': 'net',
                            'shields': 'shield',
                            'armor': 'armor',
                            'helmets': 'helmet',
                            'boots': 'boot',
                            'gloves': 'glove',
                            'belts': 'belt',
                            'cloaks': 'cloak',
                            'rings': 'ring',
                            'amulets': 'amulet',
                            'potions': 'potion',
                            'scrolls': 'scroll',
                            'books': 'book',
                            'maps': 'map',
                            'keys': 'key',
                            'coins': 'coin',
                            'gems': 'gem',
                            'jewels': 'jewel',
                            'pearls': 'pearl',
                            'diamonds': 'diamond',
                            'rubies': 'ruby',
                            'sapphires': 'sapphire',
                            'emeralds': 'emerald',
                            'gold': 'gold',
                            'silver': 'silver',
                            'copper': 'copper',
                            'platinum': 'platinum'
                        };
                        
                        // Convert to singular if it's in our map
                        if (singularMap[apiName.toLowerCase()]) {
                            apiName = singularMap[apiName.toLowerCase()];
                        } else {
                            // Try to convert common plural endings to singular
                            apiName = apiName.replace(/s$/, ''); // Remove trailing 's'
                        }
                    }
                    
                    if (type === 'skill' && skillNameToIndex[name]) {
                        apiName = skillNameToIndex[name];
                    }
                    if (type === 'proficiency' && proficiencyNameToIndex[name]) {
                        apiName = proficiencyNameToIndex[name];
                    }
                    // Use plural endpoint for skills and proficiencies
                    let apiType = type;
                    if (type === 'skill') apiType = 'skills';
                    if (type === 'proficiency') apiType = 'proficiencies';
                    const detailsDiv = this.nextElementSibling;
                    
                    // Toggle visibility
                    if (detailsDiv.classList.contains('hidden')) {
                        // Show loading state
                        detailsDiv.innerHTML = '<p class="text-gray-400">Loading...</p>';
                        detailsDiv.classList.remove('hidden');
                        
                        try {
                            // Debug logging
                            console.log(`Fetching ${type} details for: ${name} (normalized: ${apiName})`);
                            const url = `/api/${apiType}/${encodeURIComponent(apiName)}`;
                            console.log(`API URL: ${url}`);
                            
                            // Fetch details from API
                            const response = await fetch(url);
                            console.log(`Response status: ${response.status}`);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            console.log(`Response data:`, data);
                            
                            if (data.status === 'success') {
                                detailsDiv.innerHTML = formatItemDetails(data.details, type);
                            } else {
                                detailsDiv.innerHTML = `<p class="text-red-400">Error: ${data.message}</p>`;
                            }
                        } catch (error) {
                            console.error('Error fetching details:', error);
                            detailsDiv.innerHTML = `<p class="text-red-400">Error loading details: ${error.message}</p>`;
                        }
                    } else {
                        // Hide details
                        detailsDiv.classList.add('hidden');
                    }
                });
            });
        }

        // Format item details for display
        function formatItemDetails(details, type) {
            if (details.error) {
                return `<p class="text-red-400">${details.error}</p>`;
            }
            
            let html = '';
            
            switch (type) {
                case 'equipment':
                    html = formatEquipmentDetails(details);
                    break;
                case 'spell':
                    html = formatSpellDetails(details);
                    break;
                case 'skill':
                    html = formatSkillDetails(details);
                    break;
                case 'proficiency':
                    html = formatProficiencyDetails(details);
                    break;
                default:
                    html = `<p class="text-gray-400">No details available</p>`;
            }
            
            return html;
        }

        // Format equipment details
        function formatEquipmentDetails(details) {
            let html = '';
            
            if (details.name) html += `<p><strong>Name:</strong> ${details.name}</p>`;
            if (details.equipment_category) html += `<p><strong>Category:</strong> ${details.equipment_category.name}</p>`;
            if (details.cost) html += `<p><strong>Cost:</strong> ${details.cost.quantity} ${details.cost.unit}</p>`;
            if (details.weight) html += `<p><strong>Weight:</strong> ${details.weight} lbs</p>`;
            if (details.desc && details.desc.length > 0) {
                html += `<p><strong>Description:</strong></p><p>${details.desc.join(' ')}</p>`;
            }
            
            return html || '<p class="text-gray-400">No details available</p>';
        }

        // Format spell details
        function formatSpellDetails(details) {
            let html = '';
            
            if (details.name) html += `<p><strong>Name:</strong> ${details.name}</p>`;
            if (details.level) html += `<p><strong>Level:</strong> ${details.level}</p>`;
            if (details.school) html += `<p><strong>School:</strong> ${details.school.name}</p>`;
            if (details.casting_time) html += `<p><strong>Casting Time:</strong> ${details.casting_time}</p>`;
            if (details.range) html += `<p><strong>Range:</strong> ${details.range}</p>`;
            if (details.components) html += `<p><strong>Components:</strong> ${details.components.join(', ')}</p>`;
            if (details.duration) html += `<p><strong>Duration:</strong> ${details.duration}</p>`;
            if (details.desc && details.desc.length > 0) {
                html += `<p><strong>Description:</strong></p><p>${details.desc.join(' ')}</p>`;
            }
            if (details.higher_level && details.higher_level.length > 0) {
                html += `<p><strong>At Higher Levels:</strong></p><p>${details.higher_level.join(' ')}</p>`;
            }
            
            return html || '<p class="text-gray-400">No details available</p>';
        }

        // Format skill details
        function formatSkillDetails(details) {
            let html = '';
            
            if (details.name) html += `<p><strong>Name:</strong> ${details.name}</p>`;
            if (details.desc && details.desc.length > 0) {
                html += `<p><strong>Description:</strong></p><p>${details.desc.join(' ')}</p>`;
            }
            if (details.ability_score) html += `<p><strong>Ability Score:</strong> ${details.ability_score.name}</p>`;
            
            return html || '<p class="text-gray-400">No details available</p>';
        }

        // Format proficiency details
        function formatProficiencyDetails(details) {
            let html = '';
            
            if (details.name) html += `<p><strong>Name:</strong> ${details.name}</p>`;
            if (details.type) html += `<p><strong>Type:</strong> ${details.type}</p>`;
            if (details.classes && details.classes.length > 0) {
                html += `<p><strong>Classes:</strong> ${details.classes.map(c => c.name).join(', ')}</p>`;
            }
            if (details.races && details.races.length > 0) {
                html += `<p><strong>Races:</strong> ${details.races.map(r => r.name).join(', ')}</p>`;
            }
            if (details.desc && details.desc.length > 0) {
                html += `<p><strong>Description:</strong></p><p>${details.desc.join(' ')}</p>`;
            }
            
            return html || '<p class="text-gray-400">No details available</p>';
        }

        // Close modal when clicking outside
        document.getElementById('characterModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize when page loads
        // document.addEventListener('DOMContentLoaded', initializeCampaign);
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>